<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | JellyMart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/theme.css">
</head>

<body>
  <%- include('navbar') %>

  <div class="container my-5" style="max-width: 1100px;">
    <div class="section-title mb-4">
      <span>Checkout</span>
    </div>

    <% if (message) { %>
      <div class="alert alert-info"><%= message %></div>
    <% } %>

    <% if (cart.length === 0) { %>
      <div class="alert alert-warning text-center">Your cart is empty.</div>
      <a href="/shopping" class="pastel-btn">Back to Shopping</a>
    <% } else { %>
      <form method="POST" action="/checkout" id="checkout-form">
        <div class="row g-4">
          <div class="col-md-7">
            <div class="layout-card mb-4">
              <div class="section-title mb-3">
                <span>Delivery Information</span>
              </div>

              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="buyer_name" required>

              <label class="form-label mt-3">Email</label>
              <input type="email" class="form-control" name="buyer_email" required>

              <label class="form-label mt-3">Phone</label>
              <input type="text" class="form-control" name="buyer_phone" required>

              <label class="form-label mt-3">Delivery Method</label>
              <select class="form-select" name="delivery_method" id="delivery-method" required>
                <option value="delivery">Delivery</option>
                <option value="pickup">Self-Pickup</option>
              </select>
              <div class="form-text text-muted mt-2" id="delivery-helper">
                We'll deliver your order to the address below. Delivery fee is $4.
              </div>

              <label class="form-label mt-3">Address</label>
              <input type="text" class="form-control" name="address" id="delivery-address" required aria-describedby="address-error">
              <div class="form-text text-danger d-none" id="address-error">
                Please enter a delivery address.
              </div>
              <div class="form-text text-muted d-none" id="pickup-helper">
                Self-pickup at postal code 320115. Daily 10:00â€“20:00. Bring your order ID for verification.
              </div>
            </div>

            <div class="layout-card">
              <div class="section-title mb-3">
                <span>Payment Method</span>
              </div>
              <p class="text-muted mb-2"><strong>Complete Payment via PayNow</strong></p>
              <p class="text-muted mb-3">Please scan the PayNow QR code to make payment.</p>
              <img src="/images/paynow-qr.png" alt="PayNow QR" style="max-width: 220px;" class="mb-3">
              <p class="text-muted mb-2">
                After payment, click the button below to message <strong>@dog_miao</strong> on Telegram with your payment screenshot and order details.
              </p>
              <input type="hidden" name="payment_method" value="PayNow">
            </div>
          </div>

          <div class="col-md-5">
            <div class="layout-card">
              <div class="section-title mb-3">
                <span>Order Summary</span>
              </div>

              <% 
                let subtotal = 0;
                cart.forEach(item => {
                  subtotal += item.price * item.quantity;
              %>

              <div class="d-flex justify-content-between small mb-2">
                <div><%= item.productName %> x <%= item.quantity %></div>
                <div>$<%= (item.price * item.quantity).toFixed(2) %></div>
              </div>

              <% }) %>

              <hr>

              <div class="d-flex justify-content-between small">
                <span>Subtotal</span>
                <span>$<%= subtotal.toFixed(2) %></span>
              </div>

              <% 
                let baseTotal = Math.max(0, subtotal);
                let deliveryFee = 4;
                let total = baseTotal + deliveryFee;
              %>

              <div class="d-flex justify-content-between small">
                <span>Delivery Fee</span>
                <span id="delivery-fee">$<%= deliveryFee.toFixed(2) %></span>
              </div>

              <div class="d-flex justify-content-between fw-semibold mt-2">
                <span>Total</span>
                <span class="text-primary" id="order-total" data-base-total="<%= baseTotal.toFixed(2) %>">$<%= total.toFixed(2) %></span>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="pastel-btn btn-lg" id="proceed-btn" disabled>Iâ€™ve Paid â€“ Message Admin</button>
              </div>

              <div class="mt-4">
                <a href="/cart" class="pastel-secondary-btn w-100 text-center">Back to Cart</a>
              </div>
            </div>
          </div>
        </div>
      </form>
    <% } %>
  </div>

  <script>
    const form = document.getElementById("checkout-form");
    if (form) {
      const telegramLinkBase = "https://t.me/dog_miao";
      const cartItems = <%- JSON.stringify(cart.map(i => ({
        name: i.productName,
        quantity: i.quantity
      }))) %>;
      const addressInput = form.querySelector("input[name='address']");
      const deliveryInput = document.getElementById("delivery-method");
      const proceedBtn = document.getElementById("proceed-btn");
      const addressError = document.getElementById("address-error");
      const deliveryHelper = document.getElementById("delivery-helper");
      const pickupHelper = document.getElementById("pickup-helper");
      const deliveryFeeEl = document.getElementById("delivery-fee");
      const totalEl = document.getElementById("order-total");
      const baseTotal = totalEl ? parseFloat(totalEl.dataset.baseTotal || "0") : 0;
      const deliveryFeeAmount = 4;
      const nameInput = form.querySelector("input[name='buyer_name']");
      const emailInput = form.querySelector("input[name='buyer_email']");
      const phoneInput = form.querySelector("input[name='buyer_phone']");

      const updateProceedState = () => {
        const isPickup = deliveryInput.value === "pickup";
        const addressValid = isPickup ? true : addressInput.value.trim().length > 0;
        const paymentSelected = true;
        const nameValid = nameInput.value.trim().length > 0;
        const emailValid = emailInput.value.trim().length > 0;
        const phoneValid = phoneInput.value.trim().length > 0;

        if (deliveryFeeEl && totalEl) {
          const fee = isPickup ? 0 : deliveryFeeAmount;
          deliveryFeeEl.textContent = `$${fee.toFixed(2)}`;
          totalEl.textContent = `$${(baseTotal + fee).toFixed(2)}`;
        }

        addressInput.setAttribute("aria-invalid", String(!addressValid));
        addressError.classList.toggle("d-none", addressValid);
        addressInput.disabled = isPickup;
        addressInput.required = !isPickup;
        deliveryHelper.classList.toggle("d-none", isPickup);
        pickupHelper.classList.toggle("d-none", !isPickup);
        proceedBtn.disabled = !(addressValid && paymentSelected && nameValid && emailValid && phoneValid);
      };

      const saveState = () => {
        const state = {
          address: addressInput.value,
          delivery: deliveryInput.value,
          name: nameInput.value,
          email: emailInput.value,
          phone: phoneInput.value
        };
        localStorage.setItem("jm_checkout", JSON.stringify(state));
      };

      const restoreState = () => {
        try {
          const stored = JSON.parse(localStorage.getItem("jm_checkout"));
          if (!stored) return;
          if (stored.address && !addressInput.value) {
            addressInput.value = stored.address;
          }
          if (stored.delivery) {
            deliveryInput.value = stored.delivery;
          }
        if (stored.name && !nameInput.value) nameInput.value = stored.name;
        if (stored.email && !emailInput.value) emailInput.value = stored.email;
        if (stored.phone && !phoneInput.value) phoneInput.value = stored.phone;
      } catch (err) {
        localStorage.removeItem("jm_checkout");
      }
      };

      addressInput.addEventListener("input", () => {
        updateProceedState();
        saveState();
      });

      deliveryInput.addEventListener("change", () => {
        updateProceedState();
        saveState();
      });

      [nameInput, emailInput, phoneInput].forEach((input) => {
        input.addEventListener("input", () => {
          updateProceedState();
          saveState();
        });
      });

      form.addEventListener("submit", (event) => {
        updateProceedState();
        if (proceedBtn.disabled) {
          event.preventDefault();
        } else {
          const isPickup = deliveryInput.value === "pickup";
          const deliveryAddress = isPickup ? "" : addressInput.value.trim();
          const itemsText = cartItems
            .map((item) => `- ${item.name} x${item.quantity}`)
            .join("\n");
          const totalPaid = totalEl ? totalEl.textContent.replace("$", "").trim() : "";
          const message =
            "Hi! Iâ€™ve made payment for my Jellycat order ðŸ˜Š\n\n" +
            `Name: ${nameInput.value.trim()}\n` +
            `Email: ${emailInput.value.trim()}\n` +
            `Phone: ${phoneInput.value.trim()}\n\n` +
            "Items:\n" +
            `${itemsText}\n\n` +
            `Total Paid: $${totalPaid}\n` +
            "Payment Method: PayNow\n\n" +
            `Delivery Method: ${isPickup ? "Pickup" : "Delivery"}\n` +
            `Delivery Address: ${deliveryAddress}\n\n` +
            "I will send the payment screenshot next.";

          const telegramUrl = `${telegramLinkBase}?text=${encodeURIComponent(message)}`;
          window.open(telegramUrl, "_blank");
          localStorage.removeItem("jm_checkout");
        }
      });

      restoreState();
      updateProceedState();
    }
  </script>
</body>
</html>
