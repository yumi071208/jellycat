<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | JellyMart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/theme.css">
</head>

<body>
  <%- include('navbar') %>

  <div class="container my-5" style="max-width: 1100px;">
    <div class="section-title mb-4">
      <span>Checkout</span>
    </div>

    <% if (message) { %>
      <div class="alert alert-info"><%= message %></div>
    <% } %>

    <% if (cart.length === 0) { %>
      <div class="alert alert-warning text-center">Your cart is empty.</div>
      <a href="/shopping" class="pastel-btn">Back to Shopping</a>
    <% } else { %>
      <div class="layout-card mb-4">
        <div class="section-title mb-3">
          <span>Voucher</span>
        </div>

        <% if (voucher) { %>
          <div class="alert alert-success d-flex justify-content-between align-items-center">
            <div>
              <strong><%= voucher.code %></strong>
              Discount applied
            </div>
            <a href="/remove-voucher" class="pastel-secondary-btn btn-sm">Remove</a>
          </div>
        <% } else { %>
          <form method="POST" action="/apply-voucher" class="row g-2" id="voucher-form">
            <div class="col-md-8">
              <input type="text" class="form-control" name="voucherCode" id="voucher-code" placeholder="Enter voucher code" aria-describedby="voucher-error">
              <div class="form-text text-danger d-none" id="voucher-error">Please enter a voucher code.</div>
            </div>
            <div class="col-md-4">
              <button type="submit" class="pastel-btn w-100">Apply</button>
            </div>
          </form>
        <% } %>
      </div>

      <form method="POST" action="/checkout" id="checkout-form">
        <div class="row g-4">
          <div class="col-md-7">
            <div class="layout-card mb-4">
              <div class="section-title mb-3">
                <span>Delivery Information</span>
              </div>

              <label class="form-label">Delivery Method</label>
              <select class="form-select" name="delivery_method" id="delivery-method" required>
                <option value="delivery">Delivery</option>
                <option value="pickup">Self-Pickup</option>
              </select>
              <div class="form-text text-muted mt-2" id="delivery-helper">
                We'll deliver your order to the address below.
              </div>

              <label class="form-label mt-3">Address</label>
              <input type="text" class="form-control" name="address" id="delivery-address" value="<%= user.address || '' %>" required aria-describedby="address-error">
              <div class="form-text text-danger d-none" id="address-error">
                Please enter a delivery address.
              </div>
              <div class="form-text text-muted d-none" id="pickup-helper">
                Self-pickup at JellyMart, 123 Market Street. Daily 10:00â€“20:00. Bring your order ID for verification.
              </div>
            </div>

            <div class="layout-card">
              <div class="section-title mb-3">
                <span>Payment Method</span>
              </div>

            <label class="payment-option d-flex align-items-center gap-2">
              <input type="radio" name="payment_method" value="PAYPAL" form="checkout-form" required>
              <img src="/images/paypal-logo.png" style="height:20px;" alt="PayPal">
              <span>PayPal (Card)</span>
            </label>

            <label class="payment-option d-flex align-items-center gap-2">
              <input type="radio" name="payment_method" value="NETS_QR" form="checkout-form">
              <img src="/images/nets-logo.png" style="height:20px;" alt="NETS">
              <span>NETS QR (Scan to Pay)</span>
            </label>

            <label class="payment-option d-flex align-items-center gap-2">
              <input type="radio" name="payment_method" value="STRIPE" form="checkout-form">
              <img src="/images/stripe-logo.png" style="height:20px;" alt="Stripe">
              <span>Stripe (Card, Link, PayNow QR)</span>
            </label>

            <label class="payment-option d-flex align-items-center gap-2">
              <input type="radio" name="payment_method" value="AIRWALLEX" form="checkout-form">
              <img src="/images/airwallex.png" style="height:20px;" alt="Airwallex">
              <span>Airwallex (Card, Alipay, WeChat Pay)</span>
            </label>
            <input type="hidden" name="payment_method_fallback" id="payment-method-fallback" form="checkout-form" value="">
            </div>
          </div>

          <div class="col-md-5">
            <div class="layout-card">
              <div class="section-title mb-3">
                <span>Order Summary</span>
              </div>

              <% 
                let subtotal = 0;
                cart.forEach(item => {
                  subtotal += item.price * item.quantity;
              %>

              <div class="d-flex justify-content-between small mb-2">
                <div><%= item.productName %> x <%= item.quantity %></div>
                <div>$<%= (item.price * item.quantity).toFixed(2) %></div>
              </div>

              <% }) %>

              <hr>

              <div class="d-flex justify-content-between small">
                <span>Subtotal</span>
                <span>$<%= subtotal.toFixed(2) %></span>
              </div>

              <% if (voucher) { %>
                <div class="d-flex justify-content-between small text-success">
                  <span>Voucher</span>
                  <span>-$<%= voucher.calculatedDiscount.toFixed(2) %></span>
                </div>
              <% } %>

              <% 
                let discount = voucher ? voucher.calculatedDiscount : 0;
                let total = Math.max(0, subtotal - discount);
              %>

              <div class="d-flex justify-content-between fw-semibold mt-2">
                <span>Total</span>
                <span class="text-primary">$<%= total.toFixed(2) %></span>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="pastel-btn btn-lg" id="proceed-btn" disabled>Proceed to Payment</button>
                <div class="form-text text-muted mt-2" id="payment-helper" aria-live="polite">
                  Select a payment method to continue.
                </div>
              </div>

              <div class="mt-4">
                <a href="/cart" class="pastel-secondary-btn w-100 text-center">Back to Cart</a>
              </div>
            </div>
          </div>
        </div>
      </form>
    <% } %>
  </div>

  <script>
    const form = document.getElementById("checkout-form");
    const voucherForm = document.getElementById("voucher-form");
    if (form) {
      const addressInput = form.querySelector("input[name='address']");
      const deliveryInput = document.getElementById("delivery-method");
      const paymentInputs = Array.from(form.querySelectorAll("input[name='payment_method']"));
      const proceedBtn = document.getElementById("proceed-btn");
      const paymentHelper = document.getElementById("payment-helper");
      const addressError = document.getElementById("address-error");
      const deliveryHelper = document.getElementById("delivery-helper");
      const pickupHelper = document.getElementById("pickup-helper");
      const paymentFallback = document.getElementById("payment-method-fallback");
      const paymentOptions = Array.from(form.querySelectorAll(".payment-option"));

      const updateProceedState = () => {
        const isPickup = deliveryInput.value === "pickup";
        const addressValid = isPickup ? true : addressInput.value.trim().length > 0;
        const paymentSelected = paymentInputs.some((input) => input.checked);
        if (paymentFallback) {
          const selected = paymentInputs.find((input) => input.checked);
          paymentFallback.value = selected ? selected.value : "";
        }

        addressInput.setAttribute("aria-invalid", String(!addressValid));
        addressError.classList.toggle("d-none", addressValid);
        addressInput.disabled = isPickup;
        addressInput.required = !isPickup;
        deliveryHelper.classList.toggle("d-none", isPickup);
        pickupHelper.classList.toggle("d-none", !isPickup);
        proceedBtn.disabled = !(addressValid && paymentSelected);
        paymentHelper.classList.toggle("d-none", paymentSelected);
      };

      const saveState = () => {
        const selectedPayment = paymentInputs.find((input) => input.checked);
        const state = {
          address: addressInput.value,
          delivery: deliveryInput.value,
          payment: selectedPayment ? selectedPayment.value : ""
        };
        localStorage.setItem("jm_checkout", JSON.stringify(state));
      };

      const restoreState = () => {
        try {
          const stored = JSON.parse(localStorage.getItem("jm_checkout"));
          if (!stored) return;
          if (stored.address && !addressInput.value) {
            addressInput.value = stored.address;
          }
          if (stored.delivery) {
            deliveryInput.value = stored.delivery;
          }
          if (stored.payment) {
            const target = paymentInputs.find((input) => input.value === stored.payment);
          if (target) target.checked = true;
        }
        if (paymentFallback) {
          paymentFallback.value = stored.payment || "";
        }
      } catch (err) {
        localStorage.removeItem("jm_checkout");
      }
      };

      paymentInputs.forEach((input) => {
        input.addEventListener("change", () => {
          updateProceedState();
          saveState();
        });
      });

      paymentOptions.forEach((option) => {
        option.addEventListener("click", () => {
          const input = option.querySelector("input[name='payment_method']");
          if (input && !input.disabled) {
            input.checked = true;
            updateProceedState();
            saveState();
          }
        });
      });

      addressInput.addEventListener("input", () => {
        updateProceedState();
        saveState();
      });

      deliveryInput.addEventListener("change", () => {
        updateProceedState();
        saveState();
      });

      form.addEventListener("submit", (event) => {
        const selected = paymentInputs.find((input) => input.checked);
        if (paymentFallback) {
          paymentFallback.value = selected ? selected.value : "";
        }
        updateProceedState();
        if (proceedBtn.disabled || !selected) {
          event.preventDefault();
        } else {
          localStorage.removeItem("jm_checkout");
        }
      });

      restoreState();
      updateProceedState();
    }

    if (voucherForm) {
      const voucherInput = document.getElementById("voucher-code");
      const voucherError = document.getElementById("voucher-error");
      voucherForm.addEventListener("submit", (event) => {
        const value = voucherInput.value.trim();
        const valid = value.length > 0;
        voucherInput.setAttribute("aria-invalid", String(!valid));
        voucherError.classList.toggle("d-none", valid);
        if (!valid) {
          event.preventDefault();
        }
      });
    }
  </script>
</body>
</html>
