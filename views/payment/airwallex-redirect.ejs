<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airwallex Payment | JellyMart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/theme.css">
</head>
<body>
  <%- include('../navbar') %>

  <div class="container my-5" style="max-width: 720px;">
    <div class="layout-card text-center">
      <div class="section-title mb-3">
        <span>Airwallex Checkout</span>
      </div>
      <p class="text-muted" id="status">
        Redirecting to Airwallex to complete your payment...
      </p>
      <div class="mt-3">
        <a class="pastel-secondary-btn" href="/payment/airwallex/cancel">Cancel and return to checkout</a>
      </div>
    </div>
  </div>

  <script src="https://static.airwallex.com/components/sdk/v1/index.js"></script>
  <script>
    (async () => {
      const statusEl = document.getElementById('status');
      try {
        const env = "<%= airwallexEnv %>";
        const intentId = "<%= intentId %>";
        const clientSecret = "<%= clientSecret %>";
        const currency = "<%= currency %>";
        const countryCode = "<%= countryCode %>";
        const successUrl = "<%= successUrl %>";
        const failUrl = "<%= failUrl %>";

        if (!window.AirwallexComponentsSDK) {
          throw new Error('Airwallex SDK failed to load');
        }

        const { init } = window.AirwallexComponentsSDK;
        const { payments } = await init({
          env,
          enabledElements: ['payments']
        });

        await payments.redirectToCheckout({
          intent_id: intentId,
          client_secret: clientSecret,
          currency,
          country_code: countryCode,
          successUrl,
          failUrl
        });
      } catch (err) {
        const message = err && err.message ? err.message : String(err);
        statusEl.textContent = `Airwallex redirect failed: ${message}`;
      }
    })();
  </script>
</body>
</html>
